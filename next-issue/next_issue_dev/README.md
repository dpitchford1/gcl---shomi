
export APP_NAME=gcl

export LOCALEAPP_API_KEY=fA8viEEQ76Q9iuyg9hCUp7qZgmU3ajihNha25zVQ4jACLWO7fb

export COMMON_LOCALEAPP_API_KEY=CVDDvzkGjPqvlwNZs3KwuUtyFLlwwUFR1dW5iQ4gW8aIu1DrEuâ€‹

bundle install --path=vendor

get application.yml file from someone who has it and paste to config folder

redis-server to start redis in one shell

bundle exec rake localeapp:pull
	make sure that config/locales folder is populated with en.yml and fr.yml and APP_NAME/en.yml and APP_NAME/fr.yml

bundle exec rake fetch_tos

bundle exec rake fetch_offers[gcl]

bundle exec rake fetch_questions

bundle exec rails s

bundle exec sidekiq -q default -q scheduler

go to localhost:3000

Project info:

Developers: Alex Yusupov, Robert Lan., Adam Boudreau
```
To set up test environment:
1. get access to github repository, check out code. Currently the code base is develop branch, issue branch can be created based on develop branch;
2. make sure rvm is installed locally, ruby should be latest version, for example:

$ ruby -v
ruby 2.1.2p95 (2014-05-08 revision 45877) [x86_64-darwin13.0]

3. install:
$ bundle install --path=vendor

4. verify rails version:
$ bin/rails -v
Rails 4.1.1

5. start locally server:
$ bundle exec rails s

6. install Redis
$ brew install redis

7. start Redis server:
$ redis-server /usr/local/etc/redis.conf

8. start foreman
ex: ORIGIN_URL=http://localhost:3000 PORT=8080 foreman start
Make sure port within ENV['WEBSOCKETS_HTTP_URL'] & ENV['WEBSOCKETS_WS_URL'] match port foreman starts with.
If tomcat is using port 8080, try using 5000 for foreman instead.

9. load web page in browser: http://localhost:3000/, page will promopt login: userid: gcladmin, pw: rogers123.
```

To integrate with DTM:

1. include DTM code header lib and dependencies before the first Javascript tag in the page head tag in template file:
    <%# inject enjance with js: dtm header code needs to be loaded first. %><!-- dtm header code start -->
    <%= javascript_include_tag "//assets.adobedtm.com/f1c13d6275d63bceda989e7eebe142edd7f1cda0/satelliteLib-d6e7db8f23228c503813e3679e078e1e84802b6e-staging.js" %>
    <!-- dtm header code end -->

2. include DTM code footer before the page body close tag in template file:

<!-- dtm footer code start -->
<script type="text/javascript">
	new NameSpaceExtend(rdm, 'rdm.dtm.dl.video');
	rdm.dtm.dl = new RdmDtmDataLayer({
		brand : 'gcl',// Omniture brand, can be obtained from Bryan Lim;
/*	// following optional fields should be generated by the page template, you may ignore any one if not available:
		pages : '/hockey/nhl/burke-on-his-way-to-calgary/',
		section : 'sportsnet : hockey',
		subSection : 'sportsnet : hockey : nhl',
		subSection2 : '',
		subSection3 : '',
*/
		contentType : '',// 'section index' or 'article', can be obtained from Bryan Lim;
		authorName : '', // if this is a blog/article page, then this value should be set;
		vmxC4 : '7394779',//sample value for citytv, you need to obtain this value from Joey Ryken
		vmxEnabled : true
	}, this, deviceType);
// Please note: if you have Modernizr installed, you may pass device type as the 3rd parameter to RdmDtmDataLayer constructor

	_satellite.pageBottom();
</script>
<!-- dtm footer code end -->
3. If your site has Brightcove video player, make sure video player object param tag contains:

......
	<param name="includeAPI" value="true">
	<param name='templateLoadHandler' value='rogersAnalyticsBrightcoveLoadHandler'/>
......
and player Javascript library: 
	'http://admin.brightcove.com/js/BrightcoveExperiences_all.js' 
should be replaced by:
	'http://admin.brightcove.com/js/BrightcoveExperiences.js' 


To verify/QA the DTM:

1. open browser debugger console, filter out network by searching '/ss/', the beacon should fire at video starts, each segment starts, 25%|50%|75% and video complete. 

Please make sure to inform Bryan Lim in advance to let him get analytics rules set up from DTM server end.

Translation note:
When setting translations in the scope of "errors.attributes.attribute_name.error_type" results in 'is invalid' error message,
use "activemodel.errors.models.model_name.attributes.attribute_name.error_type" scope instead

Testing notes:
To run all unit tests use:
bundle exec rspec spec

To run specific tests:
1. Add focus to it block
  describe ModelName do
    it 'should test something', focus: true { expect(nil).to be_nil }
  end
2. bundle exec rspec --tag focus spec

Cucumber setup:
Start redis server, foreman, & sidekiq as explained above.

bundle exec cucumber

Prepend scenario definitions with '@javascript' tag to test javascript with poltergeist on phantomjs
Prepend scenario definitions with '@focus' and run 'bundle exec cucumber --tags @focus' to only run specific scenarios

log/test_phantomjs.log - contains javascript console.log messages
log/test_phantomjs_puts.log - contains phantomjs messages
tmp/capybara/ - folder contains both html & png of test failures

Related links:
	https://github.com/jnicklas/capybara
	https://github.com/cucumber/cucumber
	https://github.com/teampoltergeist/poltergeist

##Change Log

#####2015APR:
- Use the service api to determine if a user is known rather than checking the Profile object.
- Add /sso_version, primarily to help verify what sso code has been deployed in a given environment.
- Add sso_version to sso data elements, as this is a published api.
- Update deployment instructions.

#####2015MAR: single sign-on (sso)
- Implement sso launch: links can generate sso requests to other sites.  See the route sso_launch.

- Implement sso land: other sites can send sso requests to this site.  See the route sso_land.

- Add a hidden test page with sso links to all three portal-based sites.  Access the page from any of the portal sites by visiting any one of:

    ```shell
    https://gamecentrelive.rogers.com/sso_portal_links
    http://shomi.com/sso_portal_links
    https://www.nextissue.ca/sso_portal_links
    ```

    You will need to sign in first in order to see sso in action.
    
- Add minitest unit testing infrastructure.  To run tests do:

    ```shell
    $ bundle exec rake test
    ```

- Deployment notes are [here](docs/2015MAR_deployment_notes.md).

